<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Karabast Tester</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:'Orbitron',sans-serif; background:#000; color:#FFE81F; }
    #header { position:fixed; top:0; left:0; width:100%; height:60px; background:#121212; display:flex; align-items:center; padding:0 20px; box-shadow:0 2px 8px rgba(0,0,0,0.7); z-index:1000; }
    #header h1 { margin:0; font-size:1.4em; color:#FFE81F; }
    #header #phaseLabel { margin-left:10px; font-weight:400; font-size:1em; color:#FFF; }
    #container { position:absolute; top:60px; bottom:0; left:0; right:0; display:flex; }
    #sidebar { width:300px; background:#1e1e1e; padding:20px; display:flex; flex-direction:column; }
    #sidebarContent { overflow-y:auto; flex:1; }
    .card { background:#2a2a2a; padding:10px; margin-bottom:12px; border-radius:4px; }
    #deckManager input { width:calc(100% - 60px); padding:6px; border:none; border-radius:2px; margin-right:4px; }
    button.generic, #switchBtn, #joinBtn, #resetBtn, #deckManager button { width:100%; padding:8px; margin-bottom:8px; background:#FFE81F; border:none; border-radius:4px; color:#000; cursor:pointer; }
    #resetBtn { background:#d32f2f; color:#fff; margin-top:auto; }
    #content { flex:1; }
    ul { list-style:none; padding:0; }
    li { margin-bottom:8px; }
    .meta { font-size:0.9em; color:#ccc; }
    #previewContainer { display:none; margin-bottom:12px; }
    #previewContainer strong { display:block; margin-bottom:4px; }
    #previewImg { width:100%; border:1px solid #444; border-radius:4px; }
    body[data-phase="setup"] .gameplay { display:none; }
    body[data-phase="gameplay"] .setup { display:none; }
  </style>
</head>
<body data-phase="setup">
  <div id="header">
    <h1>Karabast Tester</h1><span id="phaseLabel">Setup Phase</span>
  </div>
  <div id="container">
    <aside id="sidebar">
      <div id="sidebarContent">
        <div class="setup">
          <h2>Decks</h2>
          <div id="deckManager" class="card">
            <input id="deckInput" placeholder="Paste deck URL" />
            <button id="addDeckBtn">Add</button>
          </div>
          <ul id="deckList"></ul>
          <button id="joinBtn" class="generic">Join Lobby</button>
        </div>
        <div class="gameplay">
          <button id="switchBtn" class="generic">Switch Player</button>
          <div id="previewContainer">
            <strong>Opponent Preview</strong>
            <img id="previewImg" alt="preview" />
          </div>
        </div>
      </div>
      <button id="resetBtn">Back to Setup</button>
    </aside>
    <div id="content"></div>
  </div>
  <script>
    const windowApi = window.api;
    const deckKey = 'savedDecks'; let decks = [];
    const body = document.body;
    const phaseLabel = document.getElementById('phaseLabel');
    const previewContainer = document.getElementById('previewContainer');
    const previewImg = document.getElementById('previewImg');

    function loadDecks() { decks = JSON.parse(localStorage.getItem(deckKey) || '[]'); }
    function saveDecks() { localStorage.setItem(deckKey, JSON.stringify(decks)); }

    async function addDeck(url) {
      const meta = await windowApi.fetchMetadata(url);
      decks.push({ url, ...meta });
      saveDecks(); renderDeckList();
    }

    function renderDeckList() {
      const list = document.getElementById('deckList'); list.innerHTML = '';
      decks.forEach((d,i) => {const li=document.createElement('li');li.innerHTML=`<div><strong>${d.name}</strong><br/><span class=\"meta\">by ${d.author}</span></div>`;const btnCopy=document.createElement('button');btnCopy.textContent='Copy';btnCopy.onclick=()=>navigator.clipboard.writeText(d.url);const btnRefresh=document.createElement('button');btnRefresh.textContent='â†»';btnRefresh.onclick=async()=>{const m=await windowApi.fetchMetadata(d.url);decks[i]={url:d.url,...m};saveDecks();renderDeckList();};const btnDelete=document.createElement('button');btnDelete.textContent='Delete';btnDelete.onclick=()=>{decks.splice(i,1);saveDecks();renderDeckList();};li.append(btnCopy,btnRefresh,btnDelete);list.appendChild(li);});
    }

    loadDecks(); renderDeckList();
    document.getElementById('addDeckBtn').addEventListener('click', () => { const url = document.getElementById('deckInput').value.trim(); if (url && !decks.find(d=>d.url===url)) addDeck(url); document.getElementById('deckInput').value=''; });

    document.getElementById('joinBtn').addEventListener('click', async () => { const url = await windowApi.readClipboard(); windowApi.joinLobby(url); });
    windowApi.onLobbySuccess(() => { body.dataset.phase = 'gameplay'; phaseLabel.textContent = 'Gameplay Phase'; });
    windowApi.onLobbyError(msg => alert(msg));

    document.getElementById('switchBtn').addEventListener('click', () => windowApi.switchPlayer());

    windowApi.onTriggerSwitch(() => { if (body.dataset.phase === 'gameplay') windowApi.switchPlayer(); });

    windowApi.onPreview(dataUrl => { if (dataUrl) { previewImg.src = dataUrl; previewContainer.style.display = 'block'; } else { previewContainer.style.display = 'none'; } });

    document.getElementById('resetBtn').addEventListener('click', () => { if (confirm('Go back to setup?')) windowApi.resetPhase(); });
    windowApi.onResetSuccess(() => { body.dataset.phase = 'setup'; phaseLabel.textContent = 'Setup Phase'; previewContainer.style.display = 'none'; });
  </script>
</body>
</html>